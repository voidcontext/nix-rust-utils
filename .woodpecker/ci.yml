pipeline:
  flake-check:
    image: nixos/nix
    commands:
      - set -o pipefail
      - .woodpecker/setup-nix.sh
      - nix flake check 2>&1 | nix run "git+https://git.vdx.hu/voidcontext/nix-cache-copy?ref=refs/tags/v0.2.0" -- -t file:///var/lib/woodpecker-agent/nix-store -k /var/lib/woodpecker-agent/nix-store/cache-priv-key.pem
    volumes:
      - /var/lib/woodpecker-agent/nix-store:/var/lib/woodpecker-agent/nix-store

  examples-check:
    image: nixos/nix
    commands:
      - set -o pipefail
      - .woodpecker/setup-nix.sh
      - .woodpecker/check-examples.sh
    volumes:
      - /var/lib/woodpecker-agent/nix-store:/var/lib/woodpecker-agent/nix-store

  nix-fmt-check:
    image: nixos/nix
    commands:
      - set -o pipefail
      - .woodpecker/setup-nix.sh
      - nix develop -c alejandra . --check | nix run "git+https://git.vdx.hu/voidcontext/nix-cache-copy?ref=refs/tags/v0.2.0" -- -t file:///var/lib/woodpecker-agent/nix-store -k /var/lib/woodpecker-agent/nix-store/cache-priv-key.pem
    volumes:
      - /var/lib/woodpecker-agent/nix-store:/var/lib/woodpecker-agent/nix-store